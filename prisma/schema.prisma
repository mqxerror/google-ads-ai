// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  mode          String    @default("simple") // "simple" | "pro"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth relations
  authAccounts Account[]
  sessions     Session[]

  // App relations
  googleAdsAccounts GoogleAdsAccount[] @relation("UserGoogleAdsAccounts")
  pendingActions    PendingAction[]
  activityLogs      ActivityLog[]
  savedViews        SavedView[]
  notifications     Notification[]
}

// NextAuth Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// NextAuth Verification Token model
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model GoogleAdsAccount {
  id               String    @id @default(cuid())
  userId           String
  googleAccountId  String // Google Ads Customer ID (123-456-7890)
  accountName      String
  accessToken      String    @db.Text // encrypted
  refreshToken     String    @db.Text // encrypted
  tokenExpiresAt   DateTime
  status           String    @default("connected") // "connected" | "disconnected" | "error"
  isManager        Boolean   @default(false) // True if this is an MCC (Manager Account)
  parentManagerId  String?   // Google Ads Customer ID of parent MCC (if this is a client account)
  lastSyncAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user            User             @relation("UserGoogleAdsAccounts", fields: [userId], references: [id], onDelete: Cascade)
  cachedCampaigns CachedCampaign[]
  pendingActions  PendingAction[]
  activityLogs    ActivityLog[]
  savedViews      SavedView[]
  automatedRules  AutomatedRule[]
  notifications   Notification[]

  @@index([userId])
  @@index([googleAccountId])
  @@index([parentManagerId])
}

model CachedCampaign {
  id              String   @id @default(cuid())
  accountId       String
  campaignId      String // Google Ads Campaign ID
  name            String
  status          String // "ENABLED" | "PAUSED" | "REMOVED"
  type            String // "SEARCH" | "PERFORMANCE_MAX" | "SHOPPING" | etc.
  budget          BigInt // Daily budget in micros
  metrics         Json // Performance metrics object
  aiScore         Int? // 0-100
  recommendations Json? // AI recommendations array
  cachedAt        DateTime @default(now())
  expiresAt       DateTime

  account GoogleAdsAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([campaignId])
}

model PendingAction {
  id           String    @id @default(cuid())
  userId       String
  accountId    String
  actionType   String // "pause" | "enable" | "adjust_budget" | etc.
  entityType   String // "campaign" | "adgroup" | "keyword" | "ad"
  entityId     String
  entityName   String
  currentValue String
  newValue     String
  riskLevel    String    @default("low") // "low" | "medium" | "high"
  status       String    @default("pending") // "pending" | "approved" | "rejected" | "executed" | "failed"
  source       String    @default("user") // "user" | "ai"
  createdAt    DateTime  @default(now())
  executedAt   DateTime?

  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  account GoogleAdsAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@index([status])
}

model ActivityLog {
  id           String   @id @default(cuid())
  userId       String
  accountId    String
  actionType   String
  entityType   String
  entityId     String
  entityName   String
  beforeValue  Json?
  afterValue   Json?
  status       String // "success" | "failed"
  errorMessage String?
  source       String   @default("user") // "user" | "ai" | "system"
  createdAt    DateTime @default(now())

  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  account GoogleAdsAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@index([createdAt])
}

model SavedView {
  id         String   @id @default(cuid())
  userId     String
  accountId  String
  name       String
  entityType String // "campaign" | "adgroup" | "keyword" | "ad"
  filters    Json // Filter configuration
  sorting    Json // Sort configuration
  columns    Json // Visible columns
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  account GoogleAdsAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
}

model UserSettings {
  id                 String   @id @default(cuid())
  userId             String   @unique
  anthropicApiKey    String?  @db.Text // encrypted
  openaiApiKey       String?  @db.Text // encrypted
  defaultLlmProvider String   @default("anthropic") // "anthropic" | "openai"
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([userId])
}

model AutomatedRule {
  id         String    @id @default(cuid())
  accountId  String
  name       String
  enabled    Boolean   @default(true)
  entityType String // "campaign" | "adGroup" | "keyword"
  condition  Json // { metric: string, operator: string, value: number, period: string }
  action     Json // { type: string, value?: number }
  lastRun    DateTime?
  nextRun    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  account GoogleAdsAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([enabled])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  accountId String?
  type      String // "alert" | "info" | "success" | "warning"
  title     String
  message   String
  read      Boolean  @default(false)
  metadata  Json?
  createdAt DateTime @default(now())

  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  account GoogleAdsAccount? @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@index([read])
  @@index([createdAt])
}
